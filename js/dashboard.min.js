var Dashboard={grid:null,elem_id:"",element:null,elem_dom:null,rand:null,interval:null,current_name:null,markdown_editors:[],all_cards:[],all_widgets:[],edit_mode:false,embed:false,ajax_cards:false,context:"core",markdown_contents:[],dash_width:0,cell_margin:3,cols:26,display:function(a){var d=typeof a!=="undefined"?a:{};var e={cols:24,rows:24,cell_length:40,cell_margin:5,rand:"",embed:false,ajax_cards:true,all_cards:[],context:"core"};d=Object.assign({},e,d);this.rand=d.rand;this.elem_id="#dashboard-"+d.rand;this.element=$(Dashboard.elem_id);this.elem_dom=Dashboard.element[0];this.current_name=$(this.elem_id+" .dashboard_select").val()||d.current;this.embed=d.embed;this.ajax_cards=d.ajax_cards;this.all_cards=d.all_cards;this.all_widgets=d.all_widgets;this.context=d.context;this.dash_width=this.element.width();this.cell_margin=d.cell_margin;this.cols=d.cols;$("#grid-stack-"+d.rand).gridstack({column:d.cols,maxRow:d.rows+1,verticalMargin:this.cell_margin,float:true,animate:false,draggable:{cancel:"textarea"}});Dashboard.grid=$("#grid-stack-"+d.rand).data("gridstack");Dashboard.grid.setStatic(true);Dashboard.generateCss();if(Dashboard.ajax_cards){Dashboard.getCardsAjax()}else{Dashboard.fitNumbers();Dashboard.animateNumbers()}$("#dashboard-"+d.rand+" .toolbar .dashboard_select").change((function(){Dashboard.current_name=$(this).val();var a=$(this).find("option:selected").text();$(".dashboard-name").val(a);Dashboard.refreshDashboard();Dashboard.setLastDashboard()}));$("#dashboard-"+d.rand+" .toolbar .add-dashboard").click((function(){Dashboard.addForm()}));$(document).on("submit",".display-add-dashboard-form",(function(a){a.preventDefault();$(".ui-dialog-content").dialog("close");var d=$(this);var e={};$.each(d.closest(".display-add-dashboard-form").serializeArray(),(function(){e[this.name]=this.value}));Dashboard.addNew(e)}));$("#dashboard-"+d.rand+" .toolbar .delete-dashboard").click((function(){Dashboard.delete()}));$("#dashboard-"+d.rand+" .toolbar .clone-dashboard").click((function(){Dashboard.clone()}));$("#dashboard-"+d.rand+" .toolbar .open-embed").click((function(){$('<div title="'+__("Share or embed this dashboard")+'"></div>').load(CFG_GLPI.root_doc+"/ajax/dashboard.php",{action:"display_embed_form",dashboard:Dashboard.current_name},(function(){$(this).dialog({width:300,modal:true,open:function(){$(this).find("input").first().focus()}})}))}));$("#dashboard-"+d.rand+" .toolbar .fa-edit").click((function(){var a=!$(this).hasClass("active");Dashboard.setEditMode(a)}));var t="#dashboard-"+d.rand+" .toggle-fullscreen";$(t).click((function(){Dashboard.toggleFullscreenMode($(this))}));$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange MSFullscreenChange",(function(){if(!document.webkitIsFullScreen&&!document.mozFullScreen&&!document.msFullscreenElement!==null){Dashboard.disableFullscreenMode()}}));$("#dashboard-"+d.rand+" .toolbar .fa-moon").click((function(){$(this).toggleClass("active");Dashboard.element.toggleClass("nightmode")}));$("#dashboard-"+d.rand+" .toolbar .fa-history").click((function(){$(this).toggleClass("active");var a=$(this).hasClass("active");if(a){var d=parseInt(CFG_GLPI.refresh_ticket_list)*60||30;Dashboard.interval=setInterval((function(){Dashboard.refreshDashboard()}),d*1e3)}else{clearInterval(Dashboard.interval)}}));var r;$(window).on("resize",(function(a){if(a.target.constructor.name!=="Window"){return}window.clearTimeout(r);r=window.setTimeout((function(){Dashboard.generateCss();Dashboard.fitNumbers();Dashboard.animateNumbers()}),200)}));$(document).on("click",".display-rights-form .save_rights",(function(){$(".ui-dialog-content").dialog("close");var a=$(this);var d={};$.each(a.closest(".display-rights-form").serializeArray(),(function(){var a=this.value.split("-");var e=a[0];var t=a[1];if(!(e in d)){d[e]=[]}d[e].push(t)}));$.ajax({method:"POST",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_rights",dashboard:Dashboard.current_name,rights:d}})}));$("#grid-stack-"+d.rand).on("dragstop",(function(){Dashboard.saveDashboard()}));$("#grid-stack-"+d.rand).on("gsresizestop",(function(a,d){Dashboard.saveDashboard();var e=$(d).find(".ct-chart");if(e.length>0){e[0].__chartist__.update()}Dashboard.fitNumbers($(d));Dashboard.animateNumbers($(d))}));$(document).on("click","#dashboard-"+d.rand+" .delete-item",(function(){var a=$(this);var d=a.closest(".grid-stack-item");Dashboard.grid.removeWidget(d);Dashboard.saveDashboard()}));$(document).on("click","#dashboard-"+d.rand+" .refresh-item",(function(){var a=$(this);var d=a.closest(".grid-stack-item");var e=d.data("gs-id");Dashboard.getCardsAjax("[data-gs-id="+e+"]")}));$(document).on("click","#dashboard-"+d.rand+" .edit-item",(function(){var a=$(this);var d=a.parent().parent(".grid-stack-item");var e=d.data("card-options");$(".ui-dialog-content").dialog("close");$('<div title="'+__("Edit this card")+'"></div>').load(CFG_GLPI.root_doc+"/ajax/dashboard.php",{action:"display_edit_widget",gridstack_id:d.data("gs-id"),card_id:e.card_id,x:d.data("gs-x"),y:d.data("gs-y"),width:d.data("gs-width"),height:d.data("gs-height"),card_options:e},(function(){$(this).dialog({width:"auto",modal:true,open:function(){$(this).find("input[type=submit]").first().focus()}})}))}));$("#dashboard-"+d.rand+" .cell-add").click((function(){var a=$(this);$(".ui-dialog-content").dialog("close");$('<div title="'+__("Add a card")+'"></div>').load(CFG_GLPI.root_doc+"/ajax/dashboard.php",{action:"display_add_widget",x:a.data("x"),y:a.data("y")},(function(){$(this).dialog({width:"auto",modal:true,open:function(){$(this).find("input[type=submit]").first().focus()}})}))}));$(document).on("submit",".display-widget-form ",(function(a){a.preventDefault();var d=$(this);var e=d.has(".edit-widget").length>0;Dashboard.setWidgetFromForm(d,e)}));$(document).on("click",".save-dashboard-name ",(function(a){a.preventDefault();$(".dashboard_select option[value="+Dashboard.current_name+"]").text($(".dashboard-name").val());Dashboard.saveDashboard();$(".display-message").addClass("success").text(__("Saved")).show("fade").delay(2e3).hide("fade")}));$(document).on("select2:select",".display-widget-form select[name=card_id]",(function(a){var d=a.params.data;var e=d.id;var t=$(this).closest(".field").siblings(".widgettype_field");var r=Dashboard.all_cards[e].widgettype;var o=r.length===1;t.show().find("input[type=radio]").next("label").css("display","none").end().filter("[value='"+r.join("'],[value='")+"']").prop("checked",o).next("label").css("display","inline-block")}));$(document).on("change",".display-widget-form [name=widgettype]",(function(){var a=$(this);var d=a.val();var e=Dashboard.all_widgets[d];var t=e.gradient||false;var r=e.limit||false;a.closest(".field").siblings(".gradient_field").hide().toggle(t).end().siblings(".limit_field").hide().toggle(r).end()}));$(document).on("input",".card.markdown textarea.markdown_content",(function(){Dashboard.saveMarkdown($(this))}))},saveMarkdown:function(a){var d=a.closest(".grid-stack-item");var e=a.val();var t=d.data("gs-id");d.addClass("dirty");Dashboard.markdown_contents[t]=e},setWidgetFromForm:function(a,d){d=d||false;$(".ui-dialog-content").dialog("close");var e={};$.each(a.serializeArray(),(function(){e[this.name]=this.value}));if(e.card_id==="0"){return false}e.card_options=e.card_options||{};if(typeof e.card_options==="string"){e.card_options=JSON.parse(e.card_options)}e.card_options.color=e.color||null;e.card_options.widgettype=e.widgettype||null;e.card_options.use_gradient=e.use_gradient||0;e.card_options.limit=e.limit||7;if(e.card_id==="markdown_editable"&&!("markdown_content"in e.card_options)){e.card_options.markdown_content=""}if(d===true){if(e.old_id==="0"){return false}var t=$(".grid-stack-item[data-gs-id="+e.old_id+"]");Dashboard.grid.removeWidget(t)}var r=getUuidV4();e.gridstack_id=e.card_id+"_"+r;e.card_options.card_id=e.card_id;e.card_options.gridstack_id=e.gridstack_id;var o=e.card_options;o.force=true;var i=Dashboard.addWidget(e);$.ajax({method:"GET",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"get_card",dashboard:Dashboard.current_name,card_id:e.card_id,args:o}}).done((function(a){i.children(".grid-stack-item-content").append(a);Dashboard.fitNumbers(i);Dashboard.animateNumbers(i);Dashboard.saveDashboard()}))},addWidget:function(a){var d=a.gridstack_id;var e=a.x||-1;var t=a.y||-1;var r=a.width||2;var o=a.height||2;var i=a.card_options||{};var s='       <div class="grid-stack-item">          <span class="controls">             <i class="refresh-item fas fa-sync-alt" title="'+__("Refresh this card")+'"></i>             <i class="edit-item fas fa-edit" title="'+__("Edit this card")+'"></i>             <i class="delete-item fas fa-times" title="'+__("Delete this card")+'"></i>          </span>          <div class="grid-stack-item-content">          </div>       </div>';var n=Dashboard.grid.addWidget(s,e,t,r,o,e<0||t<0,undefined,undefined,undefined,undefined,d);n.data("card-options",i);return n},refreshDashboard:function(){var a=$(Dashboard.elem_id+" .grid-stack");Dashboard.grid.removeAll();$.get({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{dashboard:Dashboard.current_name,action:"get_dashboard_items",embed:Dashboard.embed?1:0}}).done((function(d){a.prepend(d);a.find(".grid-stack-item").each((function(){Dashboard.grid.makeWidget($(this))}));if(Dashboard.ajax_cards){Dashboard.getCardsAjax()}}))},setLastDashboard:function(){$.ajax({method:"POST",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{dashboard:Dashboard.current_name,page:(location.origin+location.pathname).replace(CFG_GLPI.url_base,""),action:"set_last_dashboard"}})},saveDashboard:function(a){a=a|false;var d=$.makeArray(Dashboard.element.find(".grid-stack-item:visible:not(.grid-stack-placeholder)")).map((function(a){var d=$(a).data("_gridstack_node");var e=$(a).data("card-options");if(_.keys(Dashboard.markdown_contents).length>0&&d.id in Dashboard.markdown_contents){e.markdown_content=Dashboard.markdown_contents[d.id]}return d?{gridstack_id:d.id,card_id:e.card_id,x:d.x,y:d.y,width:d.width,height:d.height,card_options:e}:null}));$.ajax({method:"POST",url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_items",dashboard:Dashboard.current_name,items:d,title:$(".dashboard-name").val()}}).done((function(){if(a){Dashboard.refreshDashboard()}}))},fitNumbers:function(a){a=a||$("body");var d=.96;if(this.dash_width<=700||this.grid.container.hasClass("grid-stack-one-column-mode")){d=1.8}a.find(".big-number").find(".formatted-number").fitText(d);a.find(".big-number").find(".label").fitText(d-.2)},animateNumbers:function(a){a=a||$("body");a.find(".multiple-number, .big-number").find(".formatted-number").each((function(){var a=$(this);var d=a.data("precision");var e=a.children(".number");var t=a.children(".suffix").text();jQuery({Counter:0}).animate({Counter:e.text()},{duration:800,easing:"swing",step:function(){e.text(this.Counter.toFixed(d))+t}})}))},setEditMode:function(a){Dashboard.edit_mode=typeof a=="undefined"?true:a;var d=$(Dashboard.elem_id+" .toolbar .fa-edit");d.toggleClass("active",a);Dashboard.element.toggleClass("edit-mode",a);Dashboard.grid.setStatic(!a);if(!Dashboard.edit_mode){var e=$(".grid-stack-item.dirty");if(e.length>0){Dashboard.saveDashboard(true)}}},toggleFullscreenMode:function(a){var d=!a.hasClass("active");Dashboard.element.toggleClass("fullscreen").find(".fa-moon").toggle(d);a.toggleClass("active");if(d){Dashboard.setEditMode(false)}if(d){GoInFullscreen(Dashboard.elem_dom)}else{GoOutFullscreen()}},disableFullscreenMode:function(){Dashboard.element.removeClass("fullscreen").find(".fa-moon").hide().end().find(".toggle-fullscreen").removeClass("active");GoOutFullscreen()},clone:function(){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{dashboard:Dashboard.current_name,action:"clone_dashboard"},dataType:"json"}).done((function(a){Dashboard.addNewDashbardInSelect(a.title,a.key)}))},delete:function(){var a=__("Are you sure you want to delete the dashboard %s ?").replace("%s",Dashboard.current_name);if(window.confirm(a,__("Delete this dashboard"))){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"delete_dashboard",dashboard:Dashboard.current_name}}).done((function(){$("#dashboard-"+Dashboard.rand+" .toolbar .dashboard_select").find("option[value='"+Dashboard.current_name+"']").remove().end().prop("selectedIndex",0).trigger("change")}))}},addForm:function(){$(".ui-dialog-content").dialog("close");$('<div title="'+__("Add a new dashboard")+'"></div>').load(CFG_GLPI.root_doc+"/ajax/dashboard.php",{action:"add_new"},(function(){$(this).dialog({width:"auto",modal:true,open:function(){$(this).find("input").first().focus()}})}))},addNew:function(a){$.post({url:CFG_GLPI.root_doc+"/ajax/dashboard.php",data:{action:"save_new_dashboard",title:a.title,context:Dashboard.context}}).done((function(d){Dashboard.addNewDashbardInSelect(a.title,d);Dashboard.setEditMode(true)}))},addNewDashbardInSelect:function(a,d){var e=new Option(a,d,false,true);$("#dashboard-"+Dashboard.rand+" .toolbar .dashboard_select").append(e).trigger("change")},getCardsAjax:function(a){a=a||"";var d=[];$(".grid-stack-item:not(.lock-bottom)"+a).each((function(){var e=$(this);var t=e.data("card-options");var r=e.data("gs-id");var o=t.card_id||e.data("gs-id");t.gridstack_id=r;if("markdown_content"in t){Dashboard.markdown_contents[r]=t.markdown_content}d.push($.get(CFG_GLPI.root_doc+"/ajax/dashboard.php",{action:"get_card",dashboard:Dashboard.current_name,card_id:o,force:a.length>0?1:0,embed:Dashboard.embed?1:0,args:t}).then((function(a){e.children(".grid-stack-item-content").html(a);Dashboard.fitNumbers(e);Dashboard.animateNumbers(e)})).fail((function(){e.html("<div class='empty-card card-error'><i class='fas fa-exclamation-triangle'></i></div>")})))}));return d},easter:function(){var a=$(Dashboard.elem_id+" .grid-stack .grid-stack-item .card");setInterval((function(){var d="#"+((1<<24)*Math.random()|0).toString(16);var e=Math.floor(Math.random()*a.length)+1;var t=a[e];$(t).css("background-color",d)}),10)},generateCss:function(){var a=Math.floor(this.element.width());var d=a/this.cols;var e=d;var t=a/this.cols+this.cell_margin;var r=100/this.cols;var o="       "+this.elem_id+" .cell-add {          width: "+d+"px;          height: "+t+"px;       }       "+this.elem_id+" .grid-guide {          background-size: "+d+"px "+t+"px;          bottom: "+t+"px;       }";for(var i=0;i<this.cols;i++){var s=i*r;var n=(i+1)*r;o+=this.elem_id+" .grid-stack > .grid-stack-item[data-gs-x='"+i+"'] {             left: "+s+"%;          }          "+this.elem_id+" .grid-stack > .grid-stack-item[data-gs-width='"+(i+1)+"'] {             min-width: "+r+"%;             width: "+n+"%;          }"}$("#gs_inline_css_"+this.rand).remove();if(a>700){$("<style id='gs_inline_css_"+this.rand+"'></style>").prop("type","text/css").html(o).appendTo("head")}else{e=60}this.grid.cellHeight(e)}};